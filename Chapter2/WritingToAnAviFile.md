## [П]|[РС]|(РП) Запись видео в формате AVI

Во многих приложениях требуется записывать потоковое видео в файл и OpenCV предоставляет простые в использовании средства для этого. Просто нужно создать устройство захвата, прочитать из него кадры один за одним и при помощи созданного устройства записи поместить кадры один за другим в видео файл. Устройство записи создается при помощи функции *cvCreateVideoWriter()*.

Покадровое чтение производится при помощи функции *cvWriteFrame()*. Освобождение памяти, занимаемая устройством записи, производится при помощи функции *cvReleaseVideoWriter()*. В примере 2-11 представлена простая программа, в которой происходит чтение содержимого видео файла с диска, преобразование его в формат **logpolar** (см Главу 6 для более подробной информации) и запись в новый видео файл.

Пример 2-11. Преобразование 3-х канального видео файла в одноканальное (цветное -> оттенки серого)

```cpp
// argv[1]: имя исходного видео файла
// argv[2]: имя нового видео файла
#include “cv.h”
#include “highgui.h”

int main( int argc, char* argv[] ) {
    CvCapture* capture = 0;                     // Переменная захвата
    capture = cvCreateFileCapture( argv[1] );   // Чтение видео файла с диска

    // Не удалось захватить видео поток с диска
    // 
    if( !capture ) {
	    return -1;
    }

    // Получение первого кадра из видео потока с диска
    // 
    IplImage *bgr_frame=cvQueryFrame( capture );
    
    // Частота кадров
    // 
    double fps = cvGetCaptureProperty( capture, CV_CAP_PROP_FPS );	
    
    // Размер кадра
    //
    CvSize size = cvSize(
         (int)cvGetCaptureProperty( capture, CV_CAP_PROP_FRAME_WIDTH )
        ,(int)cvGetCaptureProperty( capture, CV_CAP_PROP_FRAME_HEIGHT )
    );
    
    // Создание устройства записи
    // 
    CvVideoWriter *writer = cvCreateVideoWriter(
         argv[2]
        ,CV_FOURCC( ‘M’,‘J’,‘P’,‘G’ )	// Кодек
        ,fps
        ,size
    );
    
    // Контейнер для промежуточного преобразования кадра
    // 
    IplImage* logpolar_frame = cvCreateImage(
         size
        ,IPL_DEPTH_8U
        ,3
    );

    // Чтение кадров, пока не закончатся
    // 
    while( (bgr_frame = cvQueryFrame( capture )) != NULL ) {
        // Преобразование
        // 
        cvLogPolar(
             bgr_frame                  // Исходный кадр
            ,logpolar_frame             // Преобразованный кадр
            ,cvPoint2D32f(              // Центр преобразования
                 bgr_frame->width/2
			    ,bgr_frame->height/2
			 )
            ,40                         // Масштабный коэффициент
            ,CV_INTER_LINEAR            // Сочетание метода интерполяции и необязательного
             + CV_WARP_FILL_OUTLIERS    // флага CV_WARP_FILL_OUTLIERS и/или CV_WARP_INVERSE_MAP
        );

        // Запись преобразованного кадра
        // 
        cvWriteFrame( writer, logpolar_frame );
    }

    // Очистка занимаемой памяти
    // 
    cvReleaseImage( &logpolar_frame );
    cvReleaseVideoWriter( &writer );	
    cvReleaseCapture( &capture );

    return(0);
}
```

Все начинается с открытия видео файла с диска; затем берется первый кадр при помощи функции *cvQueryFrame()* для определения необходимых свойств при помощи функции *cvGetCaptureProperty()*. Потом создается устройство для записи и покадрово записываются преобразованные кадры в формате log-polar в новый видео файл. В заключении происходит освобождение занимаемой памяти.

Вызов функции *cvCreateVideoWriter()* сопровождается передачей в нее нескольких параматров:

```cpp
cvCreateVideoWriter(const char* filename, int fourcc, double fps, CvSize frame_size, int is_color = 1 )
```

* fileName - имя нового видео файла
* foutcc - видео кодек, которым будет сжиматься видеопоток. 
* fps - частота кадров созданного видеопотока
* frame_size - размер кадра
* is_color - 1: кодирование цветных кадров; 0: кодирование кадров в оттенках серого

Есть бесчисленное множество кодеков; прежде чем выбрать тот или иной кодек, убедитесь, что он доступен на вашей машине (кодеки установливаются отдельно от OpenCV). В примере выбран довольно популярный кодек **MJPG**; на это указывает макрос *CV_FOURCC()*, который принимает четыре символа в качестве аргументов. Эти символы составляют "четырехзначный код" кодека, каждый кодек имеет такой код. Четырехзначный код движущейся jpg-картинки и есть MJPG (motion jpeg), потому и указано CV_FOURCC('M','J','P','G').

Список кодеков, включённых в OpenCV:

```
'X', 'V', 'I', 'D' - кодек XviD
'P', 'I', 'M', '1' - MPEG-1
'M', 'J', 'P', 'G' - motion-jpeg
'M', 'P', '4', '2' - MPEG-4.2 
'D', 'I', 'V', '3' - MPEG-4.3 
'D', 'I', 'V', 'X' - MPEG-4 
'U', '2', '6', '3' - H263 
'I', '2', '6', '3' - H263I 
'F', 'L', 'V', '1' - FLV1
```

