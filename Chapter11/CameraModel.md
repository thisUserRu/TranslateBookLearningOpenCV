## [П]|[РС]|(РП) Модель камеры

В простой модели, модели камеры обскуры, свет представляет из себя, начинающийся от сцены или удаленного объекта, единичный луч, поступающий из какой-либо конкретной точки. С точки зрения физики, эта точка затем "проецируется" на поверхность изображения. В результате, изображение на этой *плоскости изображения* (также известной как *плоскость проекции*) всегда находится в фокусе, а размер изображения относительно удаленного объекта задается одним параметром камеры: *фокусным расстоянием*. Для идеализированной камеры обскуры расстояние от диафрагмы до экрана является фокусным расстоянием. Это продемонстрировано на рисунке 11-1, где *f* - фокусное расстояние камеры, *Z* - расстояние от камеры до объекта, *X* - длина объекта и *x* - изображение объекта на плоскости изображения. На рисунке можно отметить, согласно подобию треугольников, факт того, что *-x/f = X/Z* или

![Формула 11-1 не найдена](Images/Frml_11_1.jpg)

![Рисунок 11-1 не найден](Images/Pic_11_1.jpg)

Рисунок 11-1. Модель камеры обскура: диафрагма пропускает только лишь те световые лучи, которые пересекают определенную точку в пространстве; затем эти лучи формируют изображение за счет "проекции" на плоскости изображения

Далее будет выполнено преобразование модели камеры обскура в эквивалентную модель для упрощения математических действий. Согласно рисунку 11-2 для этого необходимо произвести перестановку плоскости с отверстием и плоскости изображения. Основное отличие в результате произведенного действия заключается в том, что объект окажется на лицевой стороне. Точка на плоскости камеры обскура становиться *центром проекции*. В этом случае, каждый луч оставляет точку на удаленном объекте и направляется к центру проекции. Точка пересечения плоскости изображения и оптической оси называется *главной точкой*. На этой новой фронтальной плоскости изображения (рисунок 11-2), которая эквивалентна старой проективной плоскости или плоскости изображения, изображение удаленного объекта имеет точно такие же размеры, как и плоскость изображения на рисунке 11-1. Изображение формируется при пересечении этих лучей с плоскостью изображения, что происходит точно на расстоянии *f* от центра проекции. Это делает отношение *x/f = X/Z*, полученное из подобия треугольников, более очевидным, чем раньше. Знак минус отсутствует, т.к. изображение объекта больше не перевернутое.

![Рисунок 11-2 не найден](Images/Pic_11_2.jpg)

Рисунок 11-2. Точка Q = (X, Y, Z) проецируется на плоскость изображения лучом, проходящим через центр проекции в результирующую точку на изображении q = (x, y, z); плоскость изображения в действительности это просто проекционный экран "установленный" перед плоскостью камеры обскура

Можно подумать, что основная точка эквивалентна центру фотоприёмника, однако это будет означать, что какой-то парень с пинцетом и тюбиком клея сможет установить фотоприемник в камере с микро точностью. На самом деле, центр чипа, как правило, располагается не на оптической оси. В результате, для дальнейших объяснений будут введены два новых параметра, ![Формула 11-2 не найдена](Images/Frml_11_2.jpg) и ![Формула 11-3 не найдена](Images/Frml_11_3.jpg) для моделирования возможных перемещений (вдалеке от оптической оси) центра координат на проекционном экране. В результате относительно простая модель, в которой точка Q материального мира с координатами (X, Y, Z) проецируется на экран в какой-то заранее заданный пиксель (![Формула 11-4 не найдена](Images/Frml_11_4.jpg), ![Формула 11-5 не найдена](Images/Frml_11_5.jpg)) в соответствии со следующим уравнением (термин "экран" употребляется для напоминания о том, что координаты вычисляются в системе координат экрана (т.е. фотоприёмника); разница между (![Формула 11-4 не найдена](Images/Frml_11_4.jpg), ![Формула 11-5 не найдена](Images/Frml_11_5.jpg)) в уравнении и (x, y) на рисунке 11-2 отображена в точке ![Формула 11-2 не найдена](Images/Frml_11_2.jpg) и ![Формула 11-3 не найдена](Images/Frml_11_3.jpg)):

![Формула 11-6 не найдена](Images/Frml_11_6.jpg)

Стоит обратить внимание на то, что были введены два разных фокусных расстояния; причина этого в том, что одиночные пиксели на типичном недорогом фотоприемнике образуют прямоугольник, а не квадрат. Фокусное расстояние ![Формула 11-7 не найдена](Images/Frml_11_7.jpg) (например) на самом деле является результатом материального фокусного расстояния объектива, а ![Формула 11-8 не найдена](Images/Frml_11_8.jpg) размером отдельного элемента фотоприёмника (это имеет смысл, т.к. ![Формула 11-8 не найдена](Images/Frml_11_8.jpg) измеряется в *пиксели/миллиметр*, а *F* в *миллиметрах* (это всего лишь удобная физическая величина; ничего не мешает воспользоваться, например, "метром" или "микроном"; в любом случае ![Формула 11-8 не найдена](Images/Frml_11_8.jpg) преобразует материальные единицы в пиксели), что означает - ![Формула 11-7 не найдена](Images/Frml_11_7.jpg) в необходимых единицах пикселей). Тоже самое справедливо и для ![Формула 11-9 не найдена](Images/Frml_11_9.jpg) и ![Формула 11-10 не найдена](Images/Frml_11_10.jpg). Однако, необходимо иметь ввиду, что ![Формула 11-8 не найдена](Images/Frml_11_8.jpg) и ![Формула 11-10 не найдена](Images/Frml_11_10.jpg) не могут быть измерены в результате процесса калибровки камеры, и ни одна материальная фокусная длина *F* не может быть непосредственно измерена. Только комбинации ![Формула 11-11 не найдена](Images/Frml_11_11.jpg) и ![Формула 11-12 не найдена](Images/Frml_11_12.jpg) могут быть получены без разбора камеры и непосредственного измерения её компонентов.

### Основы геометрии проецирования

Соотношение отображения точки ![Рисунок 11-13 не найден](Images/Frml_11_13.jpg) с координатами ![Рисунок 11-14 не найден](Images/Frml_11_14.jpg) в материальном мире к точкам с координатами ![Рисунок 11-15 не найден](Images/Frml_11_15.jpg) на проекционном экране называется *проекционным преобразованием*. В работе с такими преобразованиями удобнее всего использовать так называемые *однородные координаты*. Однородные координаты, связанные с точкой из проекционного пространства размерности *n*, как правило, выражается в *(n + 1)* - мерный вектор (например, *x, y, z* становится *x, y, z, w*) с дополнительным ограничением, что любые две точки, значения которых пропорциональны, эквивалентны. Для рассматриваемого случая, плоскость изображения является пространством проекции и имеет два измерения, поэтому точка будет представлена на этой плоскости в виде трехмерных векторов q = (![Формула 11-16 не найдена](Images/Frml_11_16.jpg), ![Формула 11-17 не найдена](Images/Frml_11_17.jpg), ![Формула 11-18 не найдена](Images/Frml_11_18.jpg)). Как уже было сказано ранее, все точки, имеющие пропорциональные значения в пространстве проекции, эквивалентны, поэтому можно восстановить действительные координаты пикселя за счет деления на ![Формула 11-18 не найдена](Images/Frml_11_18.jpg). Это в свою очередь позволит организовать параметры, определяющие камеру (т.е. ![Формула 11-7 не найдена](Images/Frml_11_7.jpg), ![Формула 11-9 не найдена](Images/Frml_11_9.jpg), ![Формула 11-2 не найдена](Images/Frml_11_2.jpg), ![Формула 11-3 не найдена](Images/Frml_11_3.jpg)), в одну матрицу 3×3, которая именуется *матрицей встроенных параметров камеры* (OpenCV требует, чтобы встроенные параметры камеры происходили от Heikkila и Silven). Точки проекции в материальном мире для камеры обобщаются следующим образом:

![Формула 11-19 не найдена](Images/Frml_11_19.jpg)

В результате перемножения можно увидеть, что *w = Z*, т.к. точка *q* имеет однородные координаты, вследствие чего необходимо разделить на *w* (или *Z*) для получения предыдущего определения. (Знак минус пропал, т.к. теперь рассматривается неперевернутое изображение на плоскости проекции в передней части камеры обскура вместо перевернутого изображения на плоскости проекции за камерой обскура.)

В связи с вводом понятия однородных координат, целесообразно будет рассмотреть функцию OpenCV *cvConvertPointsHomogenious()* (да, именно *Homogenious*, в наименование функции присутствует ошибка), удобную для преобразования в и из однородных координат; помимо этого, данная функция выполняет ещё ряд полезных вещей.

```cpp
void cvConvertPointsHomogenious(
 const CvMat* src
,CvMat* dst
);
```

На первый взгляд может показаться, что у данной функции слишком простой набор аргументов; но это не так – на самом деле данная функция выполняет массу полезных вещей. Исходный массив *src* может быть ![Формула 11-20 не найдена](Images/Frml_11_20.jpg)×N или N×![Формула 11-20 не найдена](Images/Frml_11_20.jpg) (для ![Формула 11-20 не найдена](Images/Frml_11_20.jpg) = 2, 3 или 4); он также может быть 1×N или N×1 в массиве с ![Формула 11-20 не найдена](Images/Frml_11_20.jpg) = 2, 3 или 4 канала (N может быть любым числом; по существу это точки для преобразования, которые заполняют матрицу *src*). Конечный массив *dst* может быть любого типа с дополнительным ограничением по размерности ![Формула 11-21 не найдена](Images/Frml_11_21.jpg) – она должна быть равна ![Формула 11-20 не найдена](Images/Frml_11_20.jpg), ![Формула 11-20 не найдена](Images/Frml_11_20.jpg) – 1 или ![Формула 11-20 не найдена](Images/Frml_11_20.jpg) + 1.

Когда размерность исходного ![Формула 11-20 не найдена](Images/Frml_11_20.jpg) и конечного ![Формула 11-21 не найдена](Images/Frml_11_21.jpg) равны, происходит просто копирование (и, если необходимо, транспонирование). Если ![Формула 11-20 не найдена](Images/Frml_11_20.jpg) > ![Формула 11-21 не найдена](Images/Frml_11_21.jpg), то элементы *dst* вычисляются за счет деления всех кроме последних элементов соответствующего вектора *src* на последний элемент этого вектора (т.е. предполагается, что *src* содержит однородные координаты). Если ![Формула 11-20 не найдена](Images/Frml_11_20.jpg) < ![Формула 11-21 не найдена](Images/Frml_11_21.jpg), то происходит копирование точек, только каждый вектор массива *dst* на конце будет содержать 1 (т.е. вектора из *src* расширяются до однородных координат). 

Одним словом, при работе с данной функцией стоит принимать во внимание, что могут быть случаи (при N < 5), когда исходная и конечная размерность неодинакова. В этом случае функция вернет ошибку. Столкнувшись с данной ситуацией, необходимо дополнить матрицы фиктивными значениями. Кроме того, пользователь может передавать многоканальные матрицы Nx1 и 1xN, с числом каналов ![Формула 11-20 не найдена](Images/Frml_11_20.jpg) (![Формула 11-21 не найдена](Images/Frml_11_21.jpg)). Функция *cvReshape()* может быть использована для преобразования одноканальной матрицы к многоканальной без копирования данных.

Случай с идеальной камерой обскура - это полезная модель для некоторой трехмерной геометрии зрения. При этом стоит помнить, что через камеру обскура проходит очень малое количество света; таким образом, на практике изображение будет формироваться крайне медленно из-за ожидания получения достаточного количества света. Для ускорения процесса формирования изображения в камере необходимо собирать свет более широкой области и изгиба (т.е. фокуса), т.е. в точке проекции, где сходится свет. Для достижения этой цели необходимо использовать объектив. Объектив может фокусировать большее количество света в точке, что соответственно ускоряет визуализацию, однако, это приводит также и к появлению искажений.

### Искажения объектива

В теории, можно определить объектив, который воспроизводит без искажений. На практике, однако, объективы не идеальны. Главная причина кроется в процессе производства объективов; гораздо легче сделать более "сферический", чем более математически идеальный "параболический" объектив. Так же технически сложно точно совместить объектив и фотоприёмник. В данном разделе будут рассмотрены два основных типа искажения объектива и их моделирование. *Радиальные искажения* возникают в результате формы объектива, в то время как *тангенциальные искажения* возникают как результат сборки камеры в целом.

**Радиальные искажения**. Линзы реальных камер часто искажают расположении пикселей вблизи краев фотоприёмника. Это выпуклое явление появляется в результате эффекта "бочка" или *рыбий глаз* (хороший пример данного эффекта представлен в верхней части рисунка 11-12). Рисунок 11-3 подталкивает к пониманию возникновения радиальных искажений. У некоторых объективов лучи далекие от центра более изогнуты, чем те, которые ближе к центру. Типичный недорогой объектив обладает именно таким эффектом. Искажение "бочка" особенно заметно в недорогих веб-камерах и менее очевидно в высококачественных камерах, где за счет использования причудливой системы линз минимизируются радиальные искажения.

![Рисунок 11-3 не найден](Images/Pic_11_3.jpg)

Рисунок 11-3. Радиальные искажения: лучи, отдаленные от центра, искажены в большей степени, чем лучи, проходящие ближе к центру; таким образом, стороны квадрата скругляются на плоскости изображения (это также известно, как эффект "бочка")

Для радиальных искажений характерно, что искажение в (оптическом) центре фотоприёмника 0 и увеличивается по мере продвижения к окраине. На практике данное искажение не велико и может быть охарактеризовано несколькими первыми членами разложения в ряд Тейлора вокруг *r = 0*. (Ряд Тейлора – это математический метод для представления (потенциально) сложной функции в виде полинома подобного значения приближенной функции, по меньшей мере, в малой окрестности некоторой определенной точки (чем больше элементов будет задействовано, тем более точный результат будет получен). В рассматриваемом случае возникла необходимость расширения искажений до полинома в окрестности *r = 0*. Данный полином имеет следующий общий вид: ![Формула 11-22 не найдена](Images/Frml_11_22.jpg), а для рассматриваемого случая при *f(r) = 0* и *r = 0* следует, что ![Формула 11-23 не найдена](Images/Frml_11_23.jpg) = 0. Кроме того, функция должна быть симметричной в *r*, поэтому только коэффициенты четных степеней *r* должны быть отличны от нуля. Из всего этого следует, что для описания радиальных искажений необходимо использовать коэффициенты ![Формула 11-24 не найдена](Images/Frml_11_24.jpg), ![Формула 11-25 не найдена](Images/Frml_11_25.jpg) и (иногда) ![Формула 11-26 не найдена](Images/Frml_11_26.jpg)). Для дешевых веб-камер обычно используются первые два члена; первый условно именуется ![Формула 11-27 не найдена](Images/Frml_11_27.jpg), а второй ![Формула 11-28 не найдена](Images/Frml_11_28.jpg). Для сильно искаженных веб-камер, также необходимо задействовать и третий член ![Формула 11-29 не найдена](Images/Frml_11_29.jpg). В общем, радиально расположенные точки будут масштабированы в соответствии со следующими уравнениями:

![Формула 11-30 не найдена](Images/Frml_11_30.jpg)

![Формула 11-31 не найдена](Images/Frml_11_31.jpg)

где (x, y) - это оригинальное положение (на фотоприёмнике) искаженной точки, а (![Формула 11-32 не найдена](Images/Frml_11_32.jpg), ![Формула 11-33 не найдена](Images/Frml_11_33.jpg)) – это новое положение после коррекции. На рисунке 11-4 показано смещение прямоугольной сетки, которое вызвано радиальными искажениями. Внешние точки на внешней стороне прямоугольной сетки все больше смещаются внутрь при увеличении радиального расстояния от оптического центра.

![Рисунок 11-4 не найден](Images/Pic_11_4.jpg)

Рисунок 11-4. Сетка радиальных искажений для конкретного объектива камеры: стрелками показано, где точки на внешней прямоугольной сетки смещаются в радиально искаженном изображении (фото предоставлено Jean-Yves Bouguet)

**Тангенциальное искажение**. Эти искажения возникают в результате производственных дефектов, возникающих от не точно параллельно установленных линз к плоскости изображения, рисунок 11-5.

Тангенциальное искажение минимально характеризуется двумя дополнительными параметрами ![Формула 11-34 не найдена](Images/Frml_11_34.jpg) и ![Формула 11-35 не найдена](Images/Frml_11_35.jpg):

![Формула 11-36 не найдена](Images/Frml_11_36.jpg)

![Формула 11-37 не найдена](Images/Frml_11_37.jpg)

![Рисунок 11-5 не найден](Images/Pic_11_5.jpg)

Рисунок 11-5. Тангенциальные искажения появляются, когда объектив не полностью параллелен плоскости изображения; в дешевых камерах это может произойти, когда фотоприёмник клеится к задней поверхности камеры (фото предоставлено Sebastian Thrun)

Таким образом, в общей сложности в работе с данными искажениями будут необходимы только пять коэффициентов. В работе с OpenCV все пять коэффициентов образуют *вектор искажений*; этот вектор просто матрица 5×1, содержащая ![Формула 11-27 не найдена](Images/Frml_11_27.jpg), ![Формула 11-28 не найдена](Images/Frml_11_28.jpg), ![Формула 11-34 не найдена](Images/Frml_11_34.jpg), ![Формула 11-35 не найдена](Images/Frml_11_35.jpg) и ![Формула 11-28 не найдена](Images/Frml_11_28.jpg) (именно в таком порядке). На рисунке 11-6 показано влияние тангенциального искажения на фронтально внешнюю прямоугольную сетку точек. Точки смещаются эллиптически согласно функции положения и радиуса.

![Рисунок 11-6 не найден](Images/Pic_11_6.jpg)

Рисунок 11-6. Сетка тангенциальных искажений для конкретного объектива камеры: стрелками показано, где точки на внешней прямоугольной сетке смещаются по касательной к искаженному изображению (фото предоставлено Jean-Yves Bouguet)

Существует ещё множество других видов искажений, которые возникают в системах визуализации, но они, как правило, имеют малый эффект по сравнению с радиальным и тангенциальным искажениями. С вязи с эти данные (другие) искажения далее рассматриваться не будут.